(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x={}.hasOwnProperty,y=function(a,b){function c(){this.constructor=a}for(var d in b)x.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};g=window.Cruddy||{},g.baseUrl=g.root+"/"+g.uri,a="/backend/api/v1",p="transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd",moment.lang(null!=(w=g.locale)?w:"en"),Backbone.emulateHTTP=!0,Backbone.emulateJSON=!0,$(document).ajaxSend(function(a,b,c){return c.displayLoading?g.app.startLoading():void 0}).ajaxComplete(function(a,b,c){return c.displayLoading?g.app.doneLoading():void 0}),$.extend($.fancybox.defaults,{openEffect:"elastic"}),u=function(){return function(a){return a.replace(/_-/," ")}}(this),t=function(a,b){var c;return c=g.baseUrl+"/api/"+a,b&&(c+="/"+b),c},q=function(a){return setTimeout(a,50)},v=function(a,b,c){var d;return d=""+g.baseUrl+"/thumb?src="+encodeURIComponent(a),b&&(d+="&amp;width="+b),c&&(d+="&amp;height="+c),d},s=function(a){return"<span class='glyphicon glyphicon-"+a+"'></span>"},r=function(a,b,c,d){return null==b&&(b=null),null==c&&(c="btn-default"),null==d&&(d="button"),b&&(a=s(b)+" "+a),_.isArray(c)&&(c="btn-"+c.join(" btn-")),"<button type='"+d+"' class='btn "+c+"'>"+a.trim()+"</button>"},c=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.tagName="span",b.prototype.className="alert",b.prototype.initialize=function(a){var b;return this.$el.addClass(null!=(b=this.className+"-"+a.type)?b:"info"),this.$el.text(a.message),null!=a.timeout&&setTimeout(function(a){return function(){return a.remove()}}(this),a.timeout),this},b.prototype.render=function(){return q(function(a){return function(){return a.$el.addClass("show")}}(this)),this},b.prototype.remove=function(){return this.$el.one(p,function(a){return function(){return b.__super__.remove.apply(a,arguments)}}(this)),this.$el.removeClass("show"),this},b}(Backbone.View),g.View=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.componentId=function(a){return this.cid+"-"+a},b.prototype.$component=function(a){return this.$("#"+this.componentId(a))},b}(Backbone.View),b=function(){function a(a){this.original=new FormData,null!=a&&this.append(a)}return a.prototype.append=function(a,b){var c,d,e,f;if(void 0===b&&(b=a,a=null),b instanceof File||b instanceof Blob)return this.original.append(a,b);if(_.isArray(b)){if(_.isEmpty(b))return this.append(a,"");for(c=d=0,e=b.length;e>d;c=++d)f=b[c],this.append(this.key(a,c),f)}else{if(!_.isObject(b))return this.original.append(a,this.process(b));if(_.isFunction(b.serialize))this.append(a,b.serialize());else for(c in b)f=b[c],this.append(this.key(a,c),f)}},a.prototype.process=function(a){return null===a?"":a===!0?1:a===!1?0:a},a.prototype.key=function(a,b){return a?""+a+"["+b+"]":b},a}(),j=function(){function a(){}return a.prototype.create=function(a,b){var c;return c=this[a],null!=c?new c(b):(console.error("Failed to resolve "+a+"."),null)},a}(),e=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.initialize=function(a){return this.entity=a.entity,this},b.prototype.getType=function(){return this.attributes.type},b.prototype.getHelp=function(){return this.attributes.help},b.prototype.canFilter=function(){return"complex"===this.attributes.filter_type},b.prototype.isVisible=function(){return this.attributes.hide===!1},b}(Backbone.Model),i=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.defaults={data:[],search:""},b.prototype.initialize=function(a,b){return this.entity=b.entity,null!=b.columns&&(this.columns=b.columns),null!=b.filter&&(this.filter=b.filter),this.options={url:this.entity.url(),dataType:"json",type:"get",displayLoading:!0,success:function(a){return function(b){return a._hold=!0,a.set(b.data),a._hold=!1,a.trigger("data",a,b.data.data)}}(this),error:function(a){return function(b){return a.trigger("error",a,b)}}(this)},null!=this.filter&&this.listenTo(this.filter,"change",function(a){return function(){return a.set({current_page:1,silent:!0}),a.fetch()}}(this)),this.on("change",function(a){return function(){return a._hold?void 0:a.fetch()}}(this)),this.on("change:search",function(a){return function(){return a.set({current_page:1,silent:!0})}}(this))},b.prototype.hasData=function(){return!_.isEmpty(this.get("data"))},b.prototype.hasMore=function(){return this.get("current_page")<this.get("last_page")},b.prototype.isFull=function(){return!this.hasMore()},b.prototype.inProgress=function(){return null!=this.request},b.prototype.fetch=function(){return null!=this.request&&this.request.abort(),this.options.data=this.data(),this.request=$.ajax(this.options),this.request.always(function(a){return function(){return a.request=null}}(this)),this.trigger("request",this,this.request),this.request},b.prototype.more=function(){return this.isFull()?void 0:(this.set({current_page:this.get("current_page")+1,silent:!0}),this.fetch())},b.prototype.data=function(){var a,b;return a={order_by:this.get("order_by"),order_dir:this.get("order_dir"),page:this.get("current_page"),per_page:this.get("per_page"),keywords:this.get("search")},b=this.filterData(),_.isEmpty(b)||(a.filters=b),null!=this.columns&&(a.columns=this.columns.join(",")),a},b.prototype.filterData=function(){var a,b,c,d;if(null==this.filter)return null;a={},d=this.filter.attributes;for(b in d)c=d[b],null!==c&&""!==c&&(a[b]=c);return a},b}(Backbone.Model),o=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.defaults={search:""},b.prototype.initialize=function(a,b){return this.filters=new Backbone.Model,this.options={url:b.url,type:"get",dataType:"json",data:{simple:1},success:function(a){return function(b){var c,d,e,f;for(b=b.data,f=b.data,d=0,e=f.length;e>d;d++)c=f[d],a.data.push(c);return a.page=b.current_page,a.more=b.current_page<b.last_page,a.request=null,a.trigger("data",a,a.data),a}}(this),error:function(a){return function(b){return a.request=null,a.trigger("error",a,b),a}}(this)},null!=b.ajaxOptions&&$.extend(!0,this.options,b.ajaxOptions),this.reset(),this.on("change:search",this.refresh,this),this.listenTo(this.filters,"change",this.refresh),this},b.prototype.refresh=function(){return this.reset().next()},b.prototype.reset=function(){return this.data=[],this.page=null,this.more=!0,this},b.prototype.fetch=function(a,b,c){return null!=this.request&&this.request.abort(),$.extend(this.options.data,{page:b,keywords:a,filters:c}),this.trigger("request",this,this.request=$.ajax(this.options)),this.request},b.prototype.next=function(){var a;return this.more&&(a=null!=this.page?this.page+1:1,this.fetch(this.get("search"),a,this.filters.attributes)),this},b.prototype.inProgress=function(){return null!=this.request},b}(Backbone.Model),m=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.tagName="ul",b.prototype.className="pager",b.prototype.events={"click a":"navigate"},b.prototype.initialize=function(){return this.listenTo(this.model,"data",this.render),this.listenTo(this.model,"request",this.disable),$(document).on("keydown.pagination",$.proxy(this,"hotkeys")),this},b.prototype.hotkeys=function(a){return a.ctrlKey&&37===a.keyCode?(this.previous(),!1):a.ctrlKey&&39===a.keyCode?(this.next(),!1):this},b.prototype.page=function(a){return a>0&&a<=this.model.get("last_page")&&this.model.set("current_page",a),this},b.prototype.previous=function(){return this.page(this.model.get("current_page")-1)},b.prototype.next=function(){return this.page(this.model.get("current_page")+1)},b.prototype.navigate=function(a){return a.preventDefault(),this.model.inProgress()?void 0:this.page($(a.target).data("page"))},b.prototype.disable=function(){return this.$("a").addClass("disabled"),this},b.prototype.render=function(){var a;return a=this.model.get("last_page"),this.$el.toggle(null!=a&&a>1),a>1&&this.$el.html(this.template(this.model.get("current_page"),a)),this},b.prototype.template=function(a,b){var c;return c="",c+=this.renderLink(a-1,"&larr; "+g.lang.prev,"previous"+(a>1?"":" disabled")),null!=this.model.get("total")&&(c+=this.renderStats()),c+=this.renderLink(a+1,""+g.lang.next+" &rarr;","next"+(b>a?"":" disabled"))},b.prototype.renderStats=function(){return'<li class="stats"><span>'+this.model.get("from")+" - "+this.model.get("to")+" / "+this.model.get("total")+"</span></li>"},b.prototype.renderLink=function(a,b,c){return null==c&&(c=""),'<li class="'+c+'"><a href="#" data-page="'+a+'">'+b+"</a></li>"},b}(Backbone.View),h=function(a){function b(a){this.className+=" data-grid-"+a.entity.id,b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.tagName="table",b.prototype.className="table table-hover data-grid",b.prototype.events={"click .sortable":"setOrder","click .item":"navigate"},b.prototype.initialize=function(a){return this.entity=a.entity,this.columns=this.entity.columns.models.filter(function(a){return a.isVisible()}),this.listenTo(this.model,"data",this.updateData),this.listenTo(this.model,"change:order_by change:order_dir",this.onOrderChange),this.listenTo(this.entity,"change:instance",this.onInstanceChange)},b.prototype.onOrderChange=function(){var a,b;return a=this.model.get("order_by"),b=this.model.get("order_dir"),null!=this.orderBy&&a!==this.orderBy&&this.$("#col-"+this.orderBy+" .sortable").removeClass("asc desc"),this.orderBy=a,this.$("#col-"+this.orderBy+" .sortable").removeClass("asc desc").addClass(b),this},b.prototype.onInstanceChange=function(a,b){var c;return c=a.previous("instance"),null!=c&&(this.$("#item-"+c.id).removeClass("active"),c.off(null,null,this)),null!=b&&(this.$("#item-"+b.id).addClass("active"),b.on("sync destroy",function(a){return function(){return a.model.fetch()}}(this),this)),this},b.prototype.setOrder=function(a){var b,c;return b=$(a.target).data("id"),c=this.model.get("order_dir"),c=b===this.model.get("order_by")?"asc"===c?"desc":"asc":this.entity.columns.get(b).get("order_dir"),this.model.set({order_by:b,order_dir:c}),this},b.prototype.navigate=function(a){return g.router.navigate(this.entity.link($(a.currentTarget).data("id")),{trigger:!0}),this},b.prototype.updateData=function(a,b){return this.$(".items").replaceWith(this.renderBody(this.columns,b)),this},b.prototype.render=function(){var a;return a=this.model.get("data"),this.$el.html(this.renderHead(this.columns)+this.renderBody(this.columns,a)),this.onOrderChange(this.model),this},b.prototype.renderHead=function(a){var b,c,d,e;for(c="<thead><tr>",d=0,e=a.length;e>d;d++)b=a[d],c+=this.renderHeadCell(b);return c+="</tr></thead>"},b.prototype.renderHeadCell=function(a){return'<th class="'+a.getClass()+'" id="col-'+a.id+'">'+this.renderHeadCellValue(a)+"</th>"},b.prototype.renderHeadCellValue=function(a){var b,c;return c=_.escape(a.getHeader()),b=_.escape(a.getHelp()),a.canOrder()&&(c='<span class="sortable" data-id="'+a.id+'">'+c+"</span>"),b?'<span class="glyphicon glyphicon-question-sign" title="'+b+'"></span> '+c:c},b.prototype.renderBody=function(a,b){var c,d,e,f;if(c='<tbody class="items">',null!=b&&b.length)for(e=0,f=b.length;f>e;e++)d=b[e],c+=this.renderRow(a,d);else c+='<tr><td class="no-items" colspan="'+a.length+'">'+g.lang.no_results+"</td></tr>";return c+="</tbody>"},b.prototype.renderRow=function(a,b){var c,d,e,f,g,h;for(f=this.entity.get("instance"),c=null!=f&&b.id===f.id?"active":"",e='<tr class="item '+c+'" id="item-'+b.id+'" data-id="'+b.id+'">',g=0,h=a.length;h>g;g++)d=a[g],e+=this.renderCell(d,b);return e+="</tr>"},b.prototype.renderCell=function(a,b){return'<td class="'+a.getClass()+'">'+a.format(b[a.id])+"</td>"},b}(Backbone.View),k=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.className="field-list",b.prototype.initialize=function(a){var b;return this.forceDisable=null!=(b=a.forceDisable)?b:!1,this},b.prototype.focus=function(){var a;return null!=(a=this.primary)&&a.focus(),this},b.prototype.render=function(){var a,b,c,d;for(this.dispose(),this.$el.empty(),d=this.createFields(),b=0,c=d.length;c>b;b++)a=d[b],this.$el.append(a.el);return this},b.prototype.createFields=function(){var a,b,c,d,e;for(this.fields=function(){var b,c,d,e;for(d=this.model.entity.fields.models,e=[],b=0,c=d.length;c>b;b++)a=d[b],a.isVisible()&&e.push(a.createView(this.model,this.forceDisable).render());return e}.call(this),e=this.fields,c=0,d=e.length;d>c;c++)if(b=e[c],b.isEditable){this.primary=b;break}return this.fields},b.prototype.dispose=function(){var a,b,c,d;if(null!=this.fields)for(d=this.fields,b=0,c=d.length;c>b;b++)a=d[b],a.remove();return this.fields=null,this.primary=null,this},b.prototype.remove=function(){return this.dispose(),b.__super__.remove.apply(this,arguments)},b}(Backbone.View),l=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.className="filter-list",b.prototype.tagName="fieldset",b.prototype.initialize=function(a){return this.entity=a.entity,this.availableFilters=a.filters,this},b.prototype.render=function(){var a,b,c,d,e,f;for(this.dispose(),this.$el.html(this.template()),this.items=this.$(".filter-list-container"),f=this.availableFilters,d=0,e=f.length;e>d;d++)b=f[d],(a=this.entity.fields.get(b))&&a.canFilter()&&(c=a.createFilterInput(this.model))&&(this.filters.push(c),this.items.append(c.render().el),c.$el.wrap('<div class="form-group filter filter-'+a.id+'"></div>').parent().before("<label>"+a.getFilterLabel()+"</label>"));return this},b.prototype.template=function(){return'<div class="filter-list-container"></div>'},b.prototype.dispose=function(){var a,b,c,d;if(null!=this.filters)for(d=this.filters,b=0,c=d.length;c>b;b++)a=d[b],a.remove();return this.filters=[],this},b.prototype.remove=function(){return this.dispose(),b.__super__.remove.apply(this,arguments)},b}(Backbone.View),g.Inputs={},g.Inputs.Base=function(a){function b(a){this.key=a.key,b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.initialize=function(){return this.listenTo(this.model,"change:"+this.key,function(a,b,c){return this.applyChanges(b,!c.input||c.input!==this)}),this},b.prototype.applyChanges=function(){return this},b.prototype.render=function(){return this.applyChanges(this.getValue(),!0)},b.prototype.focus=function(){return this},b.prototype.getValue=function(){return this.model.get(this.key)},b.prototype.setValue=function(a,b){return null==b&&(b={}),b.input=this,this.model.set(this.key,a,b),this},b}(g.View),g.Inputs.Static=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.tagName="p",b.prototype.className="form-control-static",b.prototype.initialize=function(a){return null!=a.formatter&&(this.formatter=a.formatter),b.__super__.initialize.apply(this,arguments)},b.prototype.applyChanges=function(){return this.render()},b.prototype.render=function(){var a;return a=this.getValue(),null!=this.formatter&&(a=this.formatter.format(a)),this.$el.html(a),this},b}(g.Inputs.Base),g.Inputs.BaseText=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.className="form-control",b.prototype.events={change:"change",keydown:"keydown"},b.prototype.keydown=function(a){return a.ctrlKey&&13===a.keyCode?this.change():this},b.prototype.disable=function(){return this.$el.prop("disabled",!0),this},b.prototype.enable=function(){return this.$el.prop("disabled",!1),this},b.prototype.change=function(){return this.model.set(this.key,this.el.value),this},b.prototype.applyChanges=function(a,b){return b&&this.$el.val(a),this},b.prototype.focus=function(){return this.el.focus(),this},b}(g.Inputs.Base),g.Inputs.Text=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.tagName="input",b.prototype.initialize=function(a){return a.mask&&this.$el.mask(a.mask),b.__super__.initialize.apply(this,arguments)},b}(g.Inputs.BaseText),g.Inputs.Textarea=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.tagName="textarea",b}(g.Inputs.BaseText),g.Inputs.Checkbox=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.tagName="label",b.prototype.label="",b.prototype.events={change:"change"},b.prototype.initialize=function(a){return null!=a.label&&(this.label=a.label),b.__super__.initialize.apply(this,arguments)},b.prototype.change=function(){return this.setValue(this.input.prop("checked"))},b.prototype.applyChanges=function(a,b){return b&&this.input.prop("checked",a),this},b.prototype.render=function(){return this.input=$("<input>",{type:"checkbox",checked:this.getValue()}),this.$el.append(this.input),null!=this.label&&this.$el.append(this.label),this},b}(g.Inputs.Base),g.Inputs.Boolean=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.events={"click .btn":"check"},b.prototype.initialize=function(a){var c;return this.tripleState=null!=(c=a.tripleState)?c:!1,b.__super__.initialize.apply(this,arguments)},b.prototype.check=function(a){var b,c;return c=!!$(a.target).data("value"),b=this.model.get(this.key),c===b&&this.tripleState&&(c=null),this.setValue(c)},b.prototype.applyChanges=function(a){return a=function(){switch(a){case!0:return 0;case!1:return 1;default:return null}}(),this.values.removeClass("active"),null!=a&&this.values.eq(a).addClass("active"),this},b.prototype.render=function(){return this.$el.html(this.template()),this.values=this.$(".btn"),b.__super__.render.apply(this,arguments)},b.prototype.template=function(){return'<div class="btn-group">\n    <button type="button" class="btn btn-default" data-value="1">'+g.lang.yes+'</button>\n    <button type="button" class="btn btn-default" data-value="0">'+g.lang.no+"</button>\n</div>"},b.prototype.focus=function(){var a;return null!=(a=this.values)&&a[0].focus(),this},b}(g.Inputs.Base),g.Inputs.EntityDropdown=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.className="entity-dropdown",b.prototype.events={"click .btn-remove":"removeItem","click .btn-edit":"editItem","keydown [type=search]":"searchKeydown","show.bs.dropdown":"renderDropdown","shown.bs.dropdown":function(){return q(function(a){return function(){return a.selector.focus()}}(this)),this},"hidden.bs.dropdown":function(){return this.opened=!1,this}},b.prototype.mutiple=!1,b.prototype.reference=null,b.prototype.initialize=function(a){var c,d;return null!=a.multiple&&(this.multiple=a.multiple),null!=a.reference&&(this.reference=a.reference),null!=a.owner&&(this.owner=a.owner),this.allowEdit=(null!=(c=a.allowEdit)?c:!0)&&this.reference.updatePermitted(),this.active=!1,this.placeholder=null!=(d=a.placeholder)?d:g.lang.not_selected,this.disableDropdown=!1,a.constraint&&(this.constraint=a.constraint,this.listenTo(this.model,"change:"+this.constraint.field,function(){return this.checkToDisable().applyConstraint(!0)})),b.__super__.initialize.apply(this,arguments)},b.prototype.getKey=function(a){return $(a.currentTarget).closest(".ed-item").data("key")},b.prototype.removeItem=function(a){var b,c;return this.multiple?(b=this.getKey(a),c=_.clone(this.model.get(this.key)),c.splice(b,1)):c=null,this.setValue(c)},b.prototype.editItem=function(a){var b,c,d;return b=this.model.get(this.key),this.multiple&&(b=b[this.getKey(a)]),b?(c=$(a.currentTarget).prop("disabled",!0),d=this.reference.load(b.id).done(function(b){return function(d){return b.innerForm=new g.Entity.Form({model:d,inner:!0}),b.innerForm.render().$el.appendTo(document.body),q(function(){return b.innerForm.show()}),b.listenTo(d,"sync",function(d,e){return e.data?(c.parent().siblings("input").val(e.data.title),b.innerForm.remove()):b.removeItem(a)}),b.listenTo(b.innerForm,"remove",function(){return b.innerForm=null})}}(this)),d.always(function(){return c.prop("disabled",!1)}),this):void 0},b.prototype.searchKeydown=function(a){return 27===a.keyCode?(this.$el.dropdown("toggle"),!1):void 0},b.prototype.applyConstraint=function(a){var b,c;return null==a&&(a=!1),this.selector&&(b=this.model.get(this.constraint.field),null!=(c=this.selector.dataSource)&&c.filters.set(this.constraint.otherField,b),this.selector.createAttributes[this.constraint.otherField]=b),a&&this.model.set(this.key,this.multiple?[]:null),this},b.prototype.checkToDisable=function(){return this.constraint&&(_.isEmpty(this.model.get(this.constraint.field))?this.disable():this.enable()),this},b.prototype.disable=function(){return this.disableDropdown?this:(this.disableDropdown=!0,this.toggleDisableControls())},b.prototype.enable=function(){return this.disableDropdown?(this.disableDropdown=!1,this.toggleDisableControls()):this},b.prototype.toggleDisableControls=function(){return this.dropdownBtn.prop("disabled",this.disableDropdown),this.multiple||this.itemTitle.prop("disabled",this.disableDropdown),this},b.prototype.renderDropdown=function(a){var b;return this.disableDropdown?void a.preventDefault():(this.opened=!0,this.selector||(this.selector=new g.Inputs.EntitySelector({model:this.model,key:this.key,multiple:this.multiple,reference:this.reference,allowCreate:this.allowEdit,owner:this.owner}),this.constraint&&this.applyConstraint(),this.$el.append(this.selector.render().el)),b=this.selector.dataSource,b.inProgress()||b.refresh(),this.toggleOpenDirection())},b.prototype.toggleOpenDirection=function(){var a,b,c;if(this.opened)return c=$(window),a=c.height()-this.$el.offset().top-c.scrollTop()-this.$el.parent(".field-list").scrollTop(),b=a>292?"open-down":"open-up",this.$el.hasClass(b)||this.$el.removeClass("open-up open-down").addClass(b),this},b.prototype.applyChanges=function(){return this.multiple?this.renderItems():(this.updateItem(),this.$el.removeClass("open")),this.toggleOpenDirection(),this},b.prototype.render=function(){return this.dispose(),this.multiple?this.renderMultiple():this.renderSingle(),this.dropdownBtn=this.$("#"+this.cid+"-dropdown"),this.$el.attr("id",this.cid),this.checkToDisable(),this},b.prototype.renderMultiple=function(){return this.$el.append(this.items=$("<div>",{"class":"items"})),this.$el.append('<button type="button" class="btn btn-default btn-block dropdown-toggle ed-dropdown-toggle" data-toggle="dropdown" id="'+this.cid+'-dropdown" data-target="#'+this.cid+'">\n    '+g.lang.choose+'\n    <span class="caret"></span>\n</button>'),this.renderItems()},b.prototype.renderItems=function(){var a,b,c,d,e,f;for(a="",f=this.getValue(),b=d=0,e=f.length;e>d;b=++d)c=f[b],a+=this.itemTemplate(c.title,b);return this.items.html(a),this.items.toggleClass("has-items",""!==a),this},b.prototype.renderSingle=function(){return this.$el.html(this.itemTemplate("","0")),this.itemTitle=this.$(".form-control"),this.itemDelete=this.$(".btn-remove"),this.itemEdit=this.$(".btn-edit"),this.updateItem()},b.prototype.updateItem=function(){var a;return a=this.getValue(),this.itemTitle.val(a?a.title:""),this.itemDelete.toggle(!!a),this.itemEdit.toggle(!!a),this},b.prototype.itemTemplate=function(a,b){var c;return null==b&&(b=null),c='<div class="input-group input-group ed-item '+(this.multiple?"":"ed-dropdown-toggle")+'" data-key="'+b+'">\n    <input type="text" class="form-control" '+(this.multiple?"tab-index='-1'":"data-toggle='dropdown' data-target='#"+this.cid+"' placeholder='"+this.placeholder+"'")+' value="'+_.escape(a)+'" readonly>\n    <div class="input-group-btn">',this.allowEdit&&(c+='<button type="button" class="btn btn-default btn-edit" tabindex="-1">\n    <span class="glyphicon glyphicon-pencil"></span>\n</button>'),c+='<button type="button" class="btn btn-default btn-remove" tabindex="-1">\n    <span class="glyphicon glyphicon-remove"></span>\n</button>',this.multiple||(c+='<button type="button" class="btn btn-default btn-dropdown dropdown-toggle" data-toggle="dropdown" id="'+this.cid+'-dropdown" data-target="#'+this.cid+'" tab-index="1">\n    <span class="glyphicon glyphicon-search"></span>\n</button>'),c+="</div></div>"},b.prototype.focus=function(){return this.$component("dropdown").trigger("click")[0].focus(),this},b.prototype.dispose=function(){var a,b;return null!=(a=this.selector)&&a.remove(),null!=(b=this.innerForm)&&b.remove(),this},b.prototype.remove=function(){return this.dispose(),b.__super__.remove.apply(this,arguments)},b}(g.Inputs.Base),g.Inputs.EntitySelector=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.className="entity-selector",b.prototype.events={"click .item":"check","click .more":"more","click .btn-add":"add","click [type=search]":function(){return!1}},b.prototype.initialize=function(a){var c,d,e,f;return b.__super__.initialize.apply(this,arguments),this.filter=null!=(c=a.filter)?c:!1,this.multiple=null!=(d=a.multiple)?d:!1,this.reference=a.reference,this.allowSearch=null!=(e=a.allowSearch)?e:!0,this.allowCreate=(null!=(f=a.allowCreate)?f:!0)&&this.reference.createPermitted(),this.createAttributes={},this.data=[],this.buildSelected(this.model.get(this.key)),this.reference.viewPermitted()&&(this.primaryKey="id",this.dataSource=this.reference.search({ajaxOptions:{data:{owner:a.owner}}}),this.listenTo(this.dataSource,"request",this.loading),this.listenTo(this.dataSource,"data",this.renderItems),this.listenTo(this.dataSource,"error",this.displayError)),this},b.prototype.checkForMore=function(){return null!=this.moreElement&&this.items.parent().height()+50>this.moreElement.position().top&&this.more(),this},b.prototype.check=function(a){var b;return b=$(a.target).data("id").toString(),this.select(_.find(this.dataSource.data,function(a){return a.id.toString()===b})),!1},b.prototype.select=function(a){var b;return this.multiple?a.id in this.selected?b=_.filter(this.model.get(this.key),function(a){return a.id!==id}):(b=_.clone(this.model.get(this.key)),b.push(a)):b=a,this.setValue(b)},b.prototype.more=function(){return this.dataSource&&!this.dataSource.inProgress()?(this.dataSource.next(),!1):void 0},b.prototype.add=function(a){var b;return a.preventDefault(),a.stopPropagation(),b=this.reference.createInstance({attributes:this.createAttributes}),console.log(b),this.innerForm=new g.Entity.Form({model:b,inner:!0}),this.innerForm.render().$el.appendTo(document.body),q(function(a){return function(){return a.innerForm.show()}}(this)),this.listenToOnce(this.innerForm,"remove",function(a){return function(){return a.innerForm=null}}(this)),this.listenToOnce(b,"sync",function(a){return function(b,c){return a.select({id:b.id,title:c.data.title}),a.dataSource.set("search",""),a.innerForm.remove()}}(this)),this},b.prototype.applyChanges=function(a){return this.buildSelected(a),this.renderItems()},b.prototype.buildSelected=function(a){var b,c,d;if(this.selected={},this.multiple)for(c=0,d=a.length;d>c;c++)b=a[c],this.selected[b.id]=!0;else null!=a&&(this.selected[a.id]=!0);return this},b.prototype.loading=function(){var a;return null!=(a=this.moreElement)&&a.addClass("loading"),this},b.prototype.renderItems=function(){var a,b,c,d,e;if(this.moreElement=null,a="",this.dataSource.data.length||this.dataSource.more){for(e=this.dataSource.data,c=0,d=e.length;d>c;c++)b=e[c],a+=this.renderItem(b);this.dataSource.more&&(a+='<li class="more '+(this.dataSource.inProgress()?"loading":"")+'">'+g.lang.more+"</li>")}else a+="<li class='empty'>"+g.lang.no_results+"</li>";return this.items.html(a),this.dataSource.more&&(this.moreElement=this.items.children(".more"),this.checkForMore()),this},b.prototype.renderItem=function(a){var b;return b=a.id in this.selected?"selected":"",'<li class="item '+b+'" data-id="'+a.id+'">'+a.title+"</li>"},b.prototype.render=function(){return this.reference.viewPermitted()?(this.dispose(),this.$el.html(this.template()),this.items=this.$(".items"),this.renderItems(),this.items.parent().on("scroll",$.proxy(this,"checkForMore")),this.allowSearch&&this.renderSearch()):this.$el.html("<span class=error>"+g.lang.forbidden+"</span>"),this},b.prototype.renderSearch=function(){return this.searchInput=new g.Inputs.Search({model:this.dataSource,key:"search"}),this.$el.prepend(this.searchInput.render().el),this.searchInput.$el.wrap("<div class='"+(this.allowCreate?"input-group":"")+" search-input-container'></div>"),this.allowCreate&&this.searchInput.$el.after("<div class='input-group-btn'>\n    <button type='button' class='btn btn-default btn-add' tabindex='-1'>\n        <span class='glyphicon glyphicon-plus'></span>\n    </button>\n</div>"),this},b.prototype.template=function(){return'<div class="items-container"><ul class="items"><li class="more loading"></li></ul></div>'},b.prototype.focus=function(){var a;return(null!=(a=this.searchInput)?a.focus():void 0)||this.entity.done(function(a){return function(){return a.searchInput.focus()}}(this)),this},b.prototype.dispose=function(){var a,b;return null!=(a=this.searchInput)&&a.remove(),null!=(b=this.innerForm)&&b.remove(),this},b.prototype.remove=function(){return this.dispose(),b.__super__.remove.apply(this,arguments)},b}(g.Inputs.Base),g.Inputs.FileList=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.className="file-list",b.prototype.events={"change [type=file]":"appendFiles","click .action-delete":"deleteFile"},b.prototype.initialize=function(a){var c,d,e;return this.multiple=null!=(c=a.multiple)?c:!1,this.formatter=null!=(d=a.formatter)?d:{format:function(a){return a instanceof File?a.name:a}},this.accepts=null!=(e=a.accepts)?e:"",b.__super__.initialize.apply(this,arguments)},b.prototype.deleteFile=function(a){var b;return this.multiple?(b=_.clone(this.model.get(this.key)),b.splice($(a.currentTarget).data("index"),1)):b="",this.model.set(this.key,b),!1},b.prototype.appendFiles=function(a){var b,c,d,e,f;if(0!==a.target.files.length){if(this.multiple)for(c=_.clone(this.model.get(this.key)),f=a.target.files,d=0,e=f.length;e>d;d++)b=f[d],c.push(b);else c=a.target.files[0];return this.setValue(c)}},b.prototype.applyChanges=function(){return this.render()},b.prototype.render=function(){var a,b,c,d,e,f;if(d=this.model.get(this.key),a="",this.multiple)for(b=e=0,f=d.length;f>e;b=++e)c=d[b],a+=this.renderItem(c,b);else d&&(a+=this.renderItem(d));return a&&(a=this.wrapItems(a)),a+=this.renderInput(this.multiple?"<span class='glyphicon glyphicon-plus'></span> "+g.lang.add:g.lang.choose),this.$el.html(a),this},b.prototype.wrapItems=function(a){return'<ul class="list-group">'+a+"</ul>"},b.prototype.renderInput=function(a){return'<div class="btn btn-sm btn-default file-list-input-wrap">\n    <input type="file" id="'+this.componentId("input")+' accept="'+this.accepts+' "'+(this.multiple?"multiple":void 0)+">\n    "+a+"\n</div>"},b.prototype.renderItem=function(a,b){var c;return null==b&&(b=0),c=this.formatter.format(a),'<li class="list-group-item">\n    <a href="#" class="action-delete pull-right" data-index="'+b+'"><span class="glyphicon glyphicon-remove"></span></a>\n\n    '+c+"\n</li>"},b.prototype.focus=function(){return this.$component("input")[0].focus(),this},b}(g.Inputs.Base),g.Inputs.ImageList=function(a){function b(){this.readers=[],b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.className="image-list",b.prototype.initialize=function(a){var c,d;return this.width=null!=(c=a.width)?c:0,this.height=null!=(d=a.height)?d:80,b.__super__.initialize.apply(this,arguments)},b.prototype.render=function(){var a,c,d,e;for(b.__super__.render.apply(this,arguments),e=this.readers,c=0,d=e.length;d>c;c++)a=e[c],a.readAsDataURL(a.item);return this.readers=[],this.$(".fancybox").fancybox(),this},b.prototype.wrapItems=function(a){return'<ul class="image-group">'+a+"</ul>"},b.prototype.renderItem=function(a,b){return null==b&&(b=0),'<li class="image-group-item">\n    '+this.renderImage(a,b)+'\n    <a href="#" class="action-delete" data-index="'+b+'"><span class="glyphicon glyphicon-remove"></span></a>\n</li>'
},b.prototype.renderImage=function(a,b){var c,d;return null==b&&(b=0),c=this.key+b,a instanceof File?(d=a.data||"",null==a.data&&this.readers.push(this.createPreviewLoader(a,c))):d=v(a,this.width,this.height),'<a href="'+(a instanceof File?a.data||"#":g.root+"/"+a)+'" class="fancybox">\n    <img src="'+d+'" id="'+c+'">\n</a>'},b.prototype.createPreviewLoader=function(a,b){var c;return c=new FileReader,c.item=a,c.onload=function(a){return a.target.item.data=a.target.result,$("#"+b).attr("src",a.target.result).parent().attr("href",a.target.result)},c},b}(g.Inputs.FileList),g.Inputs.Search=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.attributes={type:"search",placeholder:g.lang.search},b.prototype.scheduleChange=function(){return null!=this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(function(a){return function(){return a.change()}}(this),300),this},b.prototype.keydown=function(a){return 8===a.keyCode?(this.model.set(this.key,""),!1):(this.scheduleChange(),b.__super__.keydown.apply(this,arguments))},b}(g.Inputs.Text),g.Inputs.Slug=function(a){function b(a){this.input=new g.Inputs.Text(_.clone(a)),null==a.className&&(a.className="input-group"),null!=a.attributes&&delete a.attributes,b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.events={"click .btn":"toggleSyncing"},b.prototype.initialize=function(a){var c,d,e;return c=null!=(d=a.chars)?d:"a-z0-9-_",this.regexp=new RegExp("[^"+c+"]+","g"),this.separator=null!=(e=a.separator)?e:"-",this.key=a.key,this.ref=_.isArray(a.ref)?a.ref:a.ref?[a.ref]:void 0,b.__super__.initialize.apply(this,arguments)},b.prototype.toggleSyncing=function(){return this.syncButton.hasClass("active")?this.unlink():this.link(),this},b.prototype.link=function(){return this.ref?(this.listenTo(this.model,"change:"+this.ref.join(" change:"),this.sync),this.syncButton.addClass("active"),this.input.disable(),this.sync()):void 0},b.prototype.unlink=function(){return null!=this.ref&&this.stopListening(this.model,null,this.sync),this.syncButton.removeClass("active"),this.input.enable(),this},b.prototype.linkable=function(){var a,b;return a=this.model.get(this.key),b=this.getValue(),b===a||null===a&&""===b},b.prototype.convert=function(a){return a?a.toLocaleLowerCase().replace(/\s+/g,this.separator).replace(this.regexp,""):a},b.prototype.sync=function(){return this.model.set(this.key,this.getValue()),this},b.prototype.getValue=function(){var a,b,c,d,e,f;for(a=[],f=this.ref,d=0,e=f.length;e>d;d++)b=f[d],c=this.model.get(b),c&&a.push(c);return a.length?this.convert(a.join(this.separator)):""},b.prototype.render=function(){return this.$el.html(this.template()),this.$el.prepend(this.input.render().el),null!=this.ref&&(this.syncButton=this.$(".btn"),this.linkable()&&this.link()),this},b.prototype.template=function(){return null==this.ref?"":'<div class="input-group-btn">\n    <button type="button" tabindex="-1" class="btn btn-default" title="'+g.lang.slug_sync+'"><span class="glyphicon glyphicon-link"></span></button>\n</div>'},b}(Backbone.View),g.Inputs.Select=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.tagName="select",b.prototype.initialize=function(a){var c,d;return this.items=null!=(c=a.items)?c:{},this.prompt=null!=(d=a.prompt)?d:null,b.__super__.initialize.apply(this,arguments)},b.prototype.applyChanges=function(a,b){return b&&this.$("[value='"+a+"']").prop("selected",!0),this},b.prototype.render=function(){return this.$el.html(this.template()),b.__super__.render.apply(this,arguments)},b.prototype.template=function(){var a,b,c,d,e;a="",a+=this.optionTemplate("",null!=(d=this.prompt)?d:""),e=this.items;for(b in e)c=e[b],a+=this.optionTemplate(b,c);return a},b.prototype.optionTemplate=function(a,b){return'<option value="'+_.escape(a)+'">'+_.escape(b)+"</option>"},b}(g.Inputs.Text),g.Inputs.Code=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.initialize=function(a){var c,d,e;return this.$el.height((null!=(d=a.height)?d:100)+"px"),this.editor=ace.edit(this.el),this.editor.setTheme("ace/theme/"+(null!=(e=a.theme)?e:g.ace_theme)),c=this.editor.getSession(),a.mode&&c.setMode("ace/mode/"+a.mode),c.setUseWrapMode(!0),c.setWrapLimitRange(null,null),b.__super__.initialize.apply(this,arguments)},b.prototype.applyChanges=function(a,b){return b&&(this.editor.setValue(a),this.editor.getSession().getSelection().clearSelection()),this},b.prototype.render=function(){return this.editor.on("blur",function(a){return function(){return a.model.set(a.key,a.editor.getValue(),{input:a})}}(this)),b.__super__.render.apply(this,arguments)},b.prototype.remove=function(){var a;return null!=(a=this.editor)&&a.destroy(),this.editor=null,b.__super__.remove.apply(this,arguments)},b.prototype.focus=function(){var a;return null!=(a=this.editor)&&a.focus(),this},b}(g.Inputs.Base),g.Inputs.Markdown=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.events={"show.bs.tab [data-toggle=tab]":"showTab","shown.bs.tab [data-toggle=tab]":"shownTab"},b.prototype.initialize=function(a){var c;return this.height=null!=(c=a.height)?c:200,this.editorInput=new g.Inputs.Code({model:this.model,key:this.key,theme:a.theme,mode:"markdown",height:this.height}),b.__super__.initialize.apply(this,arguments)},b.prototype.showTab=function(a){return"preview"===$(a.target).data("tab")&&this.renderPreview(),this},b.prototype.shownTab=function(a){return"editor"===$(a.traget).data("tab")?this.editorInput.focus():void 0},b.prototype.render=function(){return this.$el.html(this.template()),this.$(".tab-pane-editor").append(this.editorInput.render().el),this.preview=this.$(".tab-pane-preview"),this},b.prototype.renderPreview=function(){return this.preview.html(marked(this.getValue())),this},b.prototype.template=function(){return'<div class="markdown-editor">\n    <a href="https://help.github.com/articles/github-flavored-markdown" target="_blank" class="hint">GitHub flavored markdown</a>\n\n    <ul class="nav nav-tabs">\n        <li class="active"><a href="#'+this.cid+'-editor" data-toggle="tab" data-tab="editor" tab-index="-1">'+g.lang.markdown_source+'</a></li>\n        <li><a href="#'+this.cid+'-preview" data-toggle="tab" data-tab="preview" tab-index="-1">'+g.lang.markdown_parsed+'</a></li>\n    </ul>\n\n    <div class="tab-content">\n        <div class="tab-pane-editor tab-pane active" id="'+this.cid+'-editor"></div>\n        <div class="tab-pane-preview tab-pane" id="'+this.cid+'-preview" style="height:'+this.height+'px"></div>\n    </div>\n</div>'},b.prototype.focus=function(){var a;return a=this.$("[data-tab=editor]"),a.hasClass("active")?this.editorInput.focus():a.tab("show"),this},b}(g.Inputs.Base),g.Inputs.NumberFilter=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.className="input-group number-filter",b.prototype.events={"click .dropdown-menu a":"changeOperator",change:"changeValue"},b.prototype.initialize=function(){return this.defaultOp="=",this.getValue()||this.setValue(this.makeValue(this.defaultOp,""),{silent:!0}),b.__super__.initialize.apply(this,arguments)},b.prototype.changeOperator=function(a){var b,c;return a.preventDefault(),b=$(a.currentTarget).data("op"),c=this.getValue(),c.op!==b&&this.setValue(this.makeValue(b,c.val)),this},b.prototype.changeValue=function(a){var b;return b=this.getValue(),this.setValue(this.makeValue(b.op,a.target.value)),this},b.prototype.applyChanges=function(a,b){return this.$(".dropdown-menu li").removeClass("active"),this.$(".dropdown-menu a[data-op='"+a.op+"']").parent().addClass("active"),this.op.text(a.op),b&&this.input.val(a.val),this},b.prototype.render=function(){return this.$el.html(this.template()),this.op=this.$component("op"),this.input=this.$component("input"),this.reset=this.$component("reset"),b.__super__.render.apply(this,arguments)},b.prototype.template=function(){return'<div class="input-group-btn">\n    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">\n        <span id="'+this.componentId("op")+'" class="value">=</span>\n        <span class="caret"></span>\n    </button>\n\n    <ul class="dropdown-menu">\n        <li><a href="#" data-op="=">=</a></li>\n        <li><a href="#" data-op="&gt;">&gt;</a></li>\n        <li><a href="#" data-op="&lt;">&lt;</a></li>\n    </ul>\n</div>\n\n<input type="text" class="form-control" id="'+this.componentId("input")+'">'},b.prototype.makeValue=function(a,b){return{op:a,val:b}},b}(g.Inputs.Base),g.Fields=new j,g.Fields.BaseView=function(a){function b(a){var c,d,e,f,g,h;this.field=f=a.field,g=a.model.entity.id+"__"+f.id,this.inputId=g+"__"+a.model.cid,c=" field-",e=[f.getType(),f.id,g],d="field"+c+e.join(c),d+=" form-group",this.className=this.className?d+" "+this.className:d,this.forceDisable=null!=(h=a.forceDisable)?h:!1,b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.initialize=function(){return this.listenTo(this.model,"sync",this.handleSync),this.listenTo(this.model,"request",this.handleRequest),this.listenTo(this.model,"invalid",this.handleInvalid),this.updateContainer()},b.prototype.handleSync=function(){return this.updateContainer()},b.prototype.handleRequest=function(){return this.hideError()},b.prototype.handleInvalid=function(a,b){var c;return this.field.id in b&&(c=b[this.field.id],this.showError(_.isArray(c)?_.first(c):c)),this},b.prototype.updateContainer=function(){return this.isEditable=!this.forceDisable&&this.field.isEditable(this.model),this.$el.toggle(this.isVisible()),this.$el.toggleClass("required",this.field.isRequired(this.model)),this},b.prototype.hideError=function(){return this.error.hide(),this},b.prototype.showError=function(a){return this.error.text(a).show(),this},b.prototype.focus=function(){return this},b.prototype.render=function(){return this.$(".field-help").tooltip({container:"body",placement:"left"}),this.error=this.$("#"+this.cid+"-error"),this},b.prototype.helpTemplate=function(){var a;return a=this.field.getHelp(),a?'<span class="glyphicon glyphicon-question-sign field-help" title="'+_.escape(a)+'"></span>':""},b.prototype.errorTemplate=function(){return'<span class="help-block error" id="'+this.cid+'-error"></span>'},b.prototype.isVisible=function(){return this.isEditable||!this.model.isNew()},b.prototype.dispose=function(){return this},b.prototype.remove=function(){return this.dispose(),b.__super__.remove.apply(this,arguments)},b}(Backbone.View),g.Fields.InputView=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.updateContainer=function(){var a;return a=this.isEditable,b.__super__.updateContainer.apply(this,arguments),a!==this.isEditable?this.render():void 0},b.prototype.hideError=function(){return this.$el.removeClass("has-error"),b.__super__.hideError.apply(this,arguments)},b.prototype.showError=function(){return this.$el.addClass("has-error"),b.__super__.showError.apply(this,arguments)},b.prototype.render=function(){return this.dispose(),this.$el.html(this.template()),this.input=this.field.createInput(this.model,this.inputId,this.forceDisable),this.$el.append(this.input.render().el),this.$el.append(this.errorTemplate()),b.__super__.render.apply(this,arguments)},b.prototype.label=function(a){return null==a&&(a=this.field.getLabel()),'<label for="'+this.inputId+'" class="field-label">\n    '+this.helpTemplate()+_.escape(a)+"\n</label>"},b.prototype.template=function(){return this.label()},b.prototype.focus=function(){return this.input.focus(),this},b.prototype.dispose=function(){var a;return null!=(a=this.input)&&a.remove(),this},b}(g.Fields.BaseView),g.Fields.Base=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.viewConstructor=g.Fields.InputView,b.prototype.createView=function(a,b){return null==b&&(b=!1),new this.viewConstructor({model:a,field:this,forceDisable:b})},b.prototype.createInput=function(a,b,c){var d;return null==c&&(c=!1),!c&&this.isEditable(a)&&(d=this.createEditableInput(a,b)),d||new g.Inputs.Static({model:a,key:this.id,formatter:this})},b.prototype.createEditableInput=function(){return null},b.prototype.createFilterInput=function(){return null},b.prototype.getFilterLabel=function(){return this.attributes.label},b.prototype.format=function(a){return a||"n/a"},b.prototype.getLabel=function(){return this.attributes.label},b.prototype.isEditable=function(a){return a.isSaveable()&&this.attributes.fillable&&this.attributes.disabled!==!0&&this.attributes.disabled!==a.action()},b.prototype.isRequired=function(a){return this.attributes.required===!0||this.attributes.required===a.action()},b.prototype.isUnique=function(){return this.attributes.unique},b}(e),g.Fields.Input=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.createEditableInput=function(a,b){var c,d;return c={placeholder:this.attributes.placeholder,id:b},d=this.attributes.input_type,"textarea"===d?(c.rows=this.attributes.rows,new g.Inputs.Textarea({model:a,key:this.id,attributes:c})):(c.type=d,new g.Inputs.Text({model:a,key:this.id,mask:this.attributes.mask,attributes:c}))},b.prototype.format=function(){return"textarea"===this.attributes.input_type?"<pre>"+b.__super__.format.apply(this,arguments)+"</pre>":b.__super__.format.apply(this,arguments)},b}(g.Fields.Base),g.Fields.DateTime=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.format=function(a){return null===a?g.lang.never:moment.unix(a).calendar()},b}(g.Fields.Input),g.Fields.Boolean=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.createEditableInput=function(a){return new g.Inputs.Boolean({model:a,key:this.id})},b.prototype.createFilterInput=function(a){return new g.Inputs.Boolean({model:a,key:this.id,tripleState:!0})},b.prototype.format=function(a){return a?g.lang.yes:g.lang.no},b}(g.Fields.Base),g.Fields.BaseRelation=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.isVisible=function(){return this.getReference().viewPermitted()&&b.__super__.isVisible.apply(this,arguments)},b.prototype.getReference=function(){return this.reference||(this.reference=g.app.entity(this.attributes.reference)),this.reference},b.prototype.getFilterLabel=function(){return this.getReference().getSingularTitle()},b}(g.Fields.Base),g.Fields.Relation=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.createEditableInput=function(a){return new g.Inputs.EntityDropdown({model:a,key:this.id,multiple:this.attributes.multiple,reference:this.getReference(),owner:this.entity.id+"."+this.id,constraint:this.attributes.constraint})},b.prototype.createFilterInput=function(a){return new g.Inputs.EntityDropdown({model:a,key:this.id,reference:this.getReference(),allowEdit:!1,placeholder:g.lang.any_value,owner:this.entity.id+"."+this.id,constraint:this.attributes.constraint})},b.prototype.format=function(a){return _.isEmpty(a)?g.lang.not_selected:this.attributes.multiple?_.pluck(a,"title").join(", "):a.title},b.prototype.isEditable=function(){return b.__super__.isEditable.apply(this,arguments)&&this.getReference().viewPermitted()},b.prototype.canFilter=function(){return b.__super__.canFilter.apply(this,arguments)&&this.getReference().viewPermitted()},b}(g.Fields.BaseRelation),g.Fields.File=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.createEditableInput=function(a){return new g.Inputs.FileList({model:a,key:this.id,multiple:this.attributes.multiple,accepts:this.attributes.accepts})},b.prototype.format=function(a){return a instanceof b?a.name:a},b}(g.Fields.Base),g.Fields.Image=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.createEditableInput=function(a){return new g.Inputs.ImageList({model:a,key:this.id,width:this.attributes.width,height:this.attributes.height,multiple:this.attributes.multiple,accepts:this.attributes.accepts})},b}(g.Fields.File),g.Fields.Slug=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.createEditableInput=function(a){return new g.Inputs.Slug({model:a,key:this.id,chars:this.attributes.chars,ref:this.attributes.ref,separator:this.attributes.separator,attributes:{placeholder:this.attributes.placeholder}})},b}(g.Fields.Base),g.Fields.Enum=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.createEditableInput=function(a,b){return new g.Inputs.Select({model:a,key:this.id,prompt:this.attributes.prompt,items:this.attributes.items,attributes:{id:b}})},b.prototype.createFilterInput=function(a){return new g.Inputs.Select({model:a,key:this.id,prompt:g.lang.any_value,items:this.attributes.items})},b.prototype.format=function(a){var b;return b=this.attributes.items,a in b?b[a]:"n/a"},b}(g.Fields.Base),g.Fields.Markdown=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.createEditableInput=function(a){return new g.Inputs.Markdown({model:a,key:this.id,height:this.attributes.height,theme:this.attributes.theme})},b}(g.Fields.Base),g.Fields.Code=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.createEditableInput=function(a){return new g.Inputs.Code({model:a,key:this.id,height:this.attributes.height,mode:this.attributes.mode,theme:this.attributes.theme})},b}(g.Fields.Base),g.Fields.EmbeddedView=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.className="has-many-view",b.prototype.events={"click .btn-create":"create"},b.prototype.initialize=function(){return this.views={},this.collection=this.model.get(this.field.id),this.listenTo(this.collection,"add",this.add),this.listenTo(this.collection,"remove",this.removeItem),b.__super__.initialize.apply(this,arguments)},b.prototype.handleSync=function(){return b.__super__.handleSync.apply(this,arguments),this.render()},b.prototype.handleInvalid=function(a,c){return this.field.id in c&&c[this.field.id].length&&b.__super__.handleInvalid.apply(this,arguments),this},b.prototype.create=function(a){return a.preventDefault(),a.stopPropagation(),this.collection.add(this.field.getReference().createInstance(),{focus:!0}),this},b.prototype.add=function(a,b,c){var d;return this.views[a.cid]=d=new g.Fields.EmbeddedItemView({model:a,collection:this.collection,disabled:!this.isEditable}),this.body.append(d.render().el),(null!=c?c.focus:void 0)&&q(function(){return d.focus()}),this.focusable||(this.focusable=d),this.update(),this},b.prototype.removeItem=function(a){var b;return(b=this.views[a.cid])&&(b.remove(),delete this.views[a.cid]),this.update(),this},b.prototype.render=function(){var a,c,d,e;for(this.dispose(),this.$el.html(this.template()),this.body=this.$("#"+this.cid+"-body"),this.createButton=this.$(".btn-create"),e=this.collection.models,c=0,d=e.length;d>c;c++)a=e[c],this.add(a);return b.__super__.render.apply(this,arguments)},b.prototype.update=function(){return this.createButton.toggle(this.field.isMultiple()||this.collection.isEmpty()),this},b.prototype.template=function(){var a,b;return b=this.field.getReference(),a=this.isEditable&&b.createPermitted()?r("","plus",["default","create"]):"","<div class='header field-label'>\n    "+this.helpTemplate()+_.escape(this.field.getLabel())+" "+a+'\n</div>\n<div class="error-container has-error">'+this.errorTemplate()+"</div>\n<div class='body' id='"+this.cid+"-body'></div>"},b.prototype.dispose=function(){var a,b,c;c=this.views;for(a in c)b=c[a],b.remove();return this.views={},this.focusable=null,this},b.prototype.remove=function(){return this.dispose(),b.__super__.remove.apply(this,arguments)},b.prototype.focus=function(){var a;return null!=(a=this.focusable)&&a.focus(),this},b}(g.Fields.BaseView),g.Fields.EmbeddedItemView=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.className="has-many-item-view",b.prototype.events={"click .btn-delete":"deleteItem"},b.prototype.initialize=function(a){var c;return this.collection=a.collection,this.disabled=null!=(c=a.disabled)?c:!0,b.__super__.initialize.apply(this,arguments)},b.prototype.deleteItem=function(a){return a.preventDefault(),a.stopPropagation(),this.collection.remove(this.model),this},b.prototype.render=function(){return this.dispose(),this.$el.html(this.template()),this.fieldList=new k({model:this.model,forceDisable:this.disabled}),this.$el.prepend(this.fieldList.render().el),this},b.prototype.template=function(){return this.disabled||!this.model.entity.deletePermitted()&&!this.model.isNew()?"":r(g.lang["delete"],"trash",["default","sm","delete"])},b.prototype.dispose=function(){var a;return null!=(a=this.fieldList)&&a.remove(),this.fieldList=null,this},b.prototype.remove=function(){return this.dispose(),b.__super__.remove.apply(this,arguments)},b.prototype.focus=function(){var a;return null!=(a=this.fieldList)&&a.focus(),this},b}(Backbone.View),g.Fields.RelatedCollection=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.initialize=function(a,c){return this.owner=c.owner,this.field=c.field,this.deleted=!1,this.listenTo(this.owner,"sync",function(a){return function(){return a.deleted=!1}}(this)),b.__super__.initialize.apply(this,arguments)},b.prototype.remove=function(){return this.deleted=!0,b.__super__.remove.apply(this,arguments)},b.prototype.hasChangedSinceSync=function(){var a,b,c,d;if(this.deleted)return!0;for(d=this.models,b=0,c=d.length;c>b;b++)if(a=d[b],a.hasChangedSinceSync())return!0;return!1},b.prototype.copy=function(a){var b,c;return c=this.field.isUnique()?[]:function(){var a,c,d,e;for(d=this.models,e=[],a=0,c=d.length;c>a;a++)b=d[a],e.push(b.copy());return e}.call(this),new g.Fields.RelatedCollection(c,{owner:a,field:this.field})},b.prototype.serialize=function(){var a,b,c,d,e;if(this.field.isMultiple()){if(_.isEmpty(this.models))return"";for(a={},e=this.models,c=0,d=e.length;d>c;c++)b=e[c],a[b.cid]=b;return a}return this.first()},b}(Backbone.Collection),g.Fields.Embedded=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.viewConstructor=g.Fields.EmbeddedView,b.prototype.createInstance=function(a,b){var c,d;return b instanceof Backbone.Collection?b:(this.attributes.multiple||(b=b||this.isRequired(a)?[b]:[]),d=this.getReference(),b=function(){var a,e,f;for(f=[],a=0,e=b.length;e>a;a++)c=b[a],f.push(d.createInstance(c));return f}(),new g.Fields.RelatedCollection(b,{owner:a,field:this}))},b.prototype.applyValues=function(a,b){var c,d;return this.attributes.multiple||(b=[b]),a.set(_.pluck(b,"attributes"),{add:!1}),d=this.getReference(),a.add(function(){var e,f,g;for(g=[],e=0,f=b.length;f>e;e++)c=b[e],a.get(c.id)||g.push(d.createInstance(c));return g}()),this},b.prototype.hasChangedSinceSync=function(a){return a.hasChangedSinceSync()},b.prototype.copy=function(a,b){return b.copy(a)},b.prototype.processErrors=function(a,b){var c,d,e;if(_.isObject(b)){if(!this.attributes.multiple)return e=a.first(),e&&e.trigger("invalid",e,b),this;for(c in b)d=b[c],e=a.get(c),e&&e.trigger("invalid",e,d);return this}},b.prototype.triggerRelated=function(a,b,c){var d,e,f,g;for(g=b.models,e=0,f=g.length;f>e;e++)d=g[e],d.trigger.apply(d,[a,d].concat(c));return this},b.prototype.isMultiple=function(){return this.attributes.multiple},b}(g.Fields.BaseRelation),g.Fields.Number=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.createEditableInput=function(a,b){return new g.Inputs.Text({model:a,key:this.id,attributes:{type:"text",id:b}})},b.prototype.createFilterInput=function(a){return new g.Inputs.NumberFilter({model:a,key:this.id})},b}(g.Fields.Base),g.Fields.Computed=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.createInput=function(a){return new g.Inputs.Static({model:a,key:this.id,formatter:this})},b.prototype.isEditable=function(){return!1},b}(g.Fields.Base),g.Columns=new j,g.Columns.Base=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.initialize=function(a){return null!=a.formatter&&(this.formatter=g.formatters.create(a.formatter,a.formatterOptions)),b.__super__.initialize.apply(this,arguments)},b.prototype.format=function(a){return null!=this.formatter?this.formatter.format(a):_.escape(a)},b.prototype.getHeader=function(){return this.attributes.header},b.prototype.getClass=function(){return"col-"+this.id},b.prototype.canOrder=function(){return this.attributes.can_order},b}(e),g.Columns.Proxy=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.initialize=function(a){var c,d;return c=null!=(d=a.field)?d:a.id,this.field=a.entity.fields.get(c),null===a.header&&this.set("header",this.field.get("label")),b.__super__.initialize.apply(this,arguments)},b.prototype.format=function(a){return null!=this.formatter?this.formatter.format(a):this.field.format(a)},b.prototype.getClass=function(){return b.__super__.getClass.apply(this,arguments)+" col-"+this.field.get("type")},b}(g.Columns.Base),g.Columns.Computed=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.getClass=function(){return b.__super__.getClass.apply(this,arguments)+" col-computed"},b}(g.Columns.Base),g.formatters=new j,f=function(){function a(a){null==a&&(a={}),this.options=$.extend({},this.defaultOptions,a)}return a.prototype.defaultOptions={},a.prototype.format=function(a){return a},a}(),g.formatters.Image=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.defaultOptions={width:40,height:40},b.prototype.format=function(a){return _.isEmpty(a)?"":(_.isArray(a)&&(a=a[0]),'<img src="'+v(a,this.options.width,this.options.height)+'" width="'+(this.options.width||this.defaultOptions.width)+'" height="'+(this.options.height||this.defaultOptions.height)+'" alt="'+_.escape(a)+'">')},b}(f),g.formatters.Plain=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.format=function(a){return _.escape(a)},b}(f),g.Entity={},g.Entity.Entity=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.initialize=function(a){return this.fields=this.createCollection(g.Fields,a.fields),this.columns=this.createCollection(g.Columns,a.columns),null===this.get("label")?this.set("label",u(this.id)):void 0},b.prototype.createCollection=function(a,b){var c,d,e,f,g;for(c=[],f=0,g=b.length;g>f;f++)e=b[f],e.entity=this,d=a.create(e["class"],e),null!=d&&c.push(d);return new Backbone.Collection(c)},b.prototype.createDataSource=function(a){var b;return null==a&&(a=null),b={order_by:this.get("order_by")},b.order_dir=null!=b.order_dir?this.columns.get(b.order_by).get("order_dir"):"asc",new i(b,{entity:this,columns:a,filter:new Backbone.Model})},b.prototype.createFilters=function(a){var b,c;return null==a&&(a=this.columns),c=function(){var c,d,e,f;for(e=a.models,f=[],c=0,d=e.length;d>c;c++)b=e[c],"complex"===b.get("filter_type")&&f.push(b.createFilter());return f}(),new Backbone.Collection(c)},b.prototype.createInstance=function(a,b){return null==a&&(a={}),null==b&&(b={}),b.extra=a.extra,b.entity=this,a=_.extend({},this.get("defaults"),a.attributes),new g.Entity.Instance(a,b)},b.prototype.getRelation=function(a){var b;return b=this.fields.get(a),b?!b instanceof g.Fields.BaseRelation?void console.error("The field "+a+" is not a relation."):b:void console.error("The field "+a+" is not found.")},b.prototype.search=function(a){return null==a&&(a={}),new o({},$.extend({url:this.url()},a))},b.prototype.load=function(a){var b;return b=$.ajax({url:this.url(a),type:"GET",dataType:"json",cache:!0,displayLoading:!0}),b.then(function(a){return function(b){return b=b.data,a.createInstance(b)}}(this))},b.prototype.actionUpdate=function(a){return this.load(a).then(function(a){return function(b){return a.set("instance",b),b}}(this))},b.prototype.actionCreate=function(){return this.set("instance",this.createInstance())},b.prototype.getCopyableAttributes=function(a,b){var c,d,e,f,g,h,i,j,k;for(c={},j=this.fields.models,f=0,h=j.length;h>f;f++)d=j[f],!d.isUnique()&&d.id in b&&!_.contains(this.attributes.related,d.id)&&(c[d.id]=b[d.id]);for(k=this.attributes.related,g=0,i=k.length;i>g;g++)e=k[g],e in b&&(c[e]=this.getRelation(e).copy(a,b[e]));return c},b.prototype.url=function(a){return t(this.id,a)},b.prototype.link=function(a){return""+this.id+(null!=a?"/"+a:"")},b.prototype.getPluralTitle=function(){return this.attributes.title.plural},b.prototype.getSingularTitle=function(){return this.attributes.title.singular},b.prototype.getPermissions=function(){return this.attributes.permissions},b.prototype.updatePermitted=function(){return this.attributes.permissions.update},b.prototype.createPermitted=function(){return this.attributes.permissions.create},b.prototype.deletePermitted=function(){return this.attributes.permissions["delete"]},b.prototype.viewPermitted=function(){return this.attributes.permissions.view},b.prototype.isSoftDeleting=function(){return this.attributes.soft_deleting},b}(Backbone.Model),g.Entity.Instance=function(a){function c(a,b){this.entity=b.entity,this.related={},c.__super__.constructor.apply(this,arguments)}return y(c,a),c.prototype.initialize=function(a,b){var c,d,e,f,g;for(this.original=_.clone(a),this.extra=null!=(f=b.extra)?f:{},this.on("error",this.processError,this),this.on("sync",this.handleSync,this),this.on("destroy",function(a){return function(){return a.entity.get("soft_deleting")?a.set("deleted_at",moment().unix()):void 0}}(this)),g=["sync","request"],d=0,e=g.length;e>d;d++)c=g[d],this.on(c,this.triggerRelated(c),this);return this},c.prototype.handleSync=function(a,b){return this.original=_.clone(this.attributes),this.extra=b.data.extra,this},c.prototype.triggerRelated=function(a){var b;return b=Array.prototype.slice,function(){var c,d,e,f;f=this.related;for(c in f)d=f[c],e=this.entity.getRelation(c),e.triggerRelated.call(e,a,d,b.call(arguments,1));return this}},c.prototype.processError=function(a,b){var c,d,e,f,g;if("VALIDATION"===(null!=(e=b.responseJSON)?e.error:void 0)){c=b.responseJSON.data,this.trigger("invalid",this,c),f=this.related,g=[];for(d in f)a=f[d],d in c&&g.push(this.entity.getRelation(d).processErrors(a,c[d]));return g}},c.prototype.validate=function(){return this.set("errors",{}),null},c.prototype.link=function(){return this.entity.link(this.isNew()?"create":this.id)},c.prototype.url=function(){return this.entity.url(this.id)},c.prototype.set=function(a,b,d){var e,f,g,h,i,j,k,l,m;if("object"==typeof a)for(e=a,d=b,g=null!=d?d.is_copy:void 0,m=this.entity.get("related"),k=0,l=m.length;l>k;k++)f=m[k],f in e&&(i=this.entity.getRelation(f),j=e[f],g?h=this.related[f]=j:f in this.related?(h=this.related[f],j&&i.applyValues(h,j)):(h=this.related[f]=i.createInstance(this,j),h.parent=this),e[f]=h);return c.__super__.set.apply(this,arguments)},c.prototype.sync=function(a,d,e){var f;return("update"===a||"create"===a)&&(e.data=new b(null!=(f=e.attrs)?f:this.attributes).original,e.contentType=!1,e.processData=!1),c.__super__.sync.apply(this,arguments)},c.prototype.parse=function(a){return a.data.attributes},c.prototype.copy=function(){var a;return a=this.entity.createInstance(),a.set(this.getCopyableAttributes(a),{silent:!0,is_copy:!0}),a},c.prototype.getCopyableAttributes=function(a){return this.entity.getCopyableAttributes(a,this.attributes)},c.prototype.hasChangedSinceSync=function(){var a,b,c;
c=this.attributes;for(a in c)if(b=c[a],a in this.related?this.entity.getRelation(a).hasChangedSinceSync(b):!_.isEqual(b,this.original[a]))return!0;return!1},c.prototype.isSaveable=function(){return this.isNew()&&this.entity.createPermitted()||!this.isNew()&&this.entity.updatePermitted()},c.prototype.serialize=function(){return{attributes:this.attributes,id:this.id}},c.prototype.action=function(){return this.isNew()?"create":"update"},c}(Backbone.Model),g.Entity.Page=function(a){function b(a){this.className+=" entity-page-"+a.model.id,b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.className="page entity-page",b.prototype.events={"click .btn-create":"create","click .btn-refresh":"refresh"},b.prototype.initialize=function(){return this.listenTo(this.model,"change:instance",this.toggleForm),b.__super__.initialize.apply(this,arguments)},b.prototype.toggleForm=function(a,b){return null!=this.form&&(this.stopListening(this.form.model),this.form.remove()),null!=b&&(this.listenTo(b,"sync",function(){return g.router.navigate(b.link())}),this.form=new g.Entity.Form({model:b}),this.$el.append(this.form.render().$el),q(function(a){return function(){return a.form.show()}}(this))),this},b.prototype.create=function(){return g.router.navigate(this.model.link("create"),{trigger:!0}),this},b.prototype.refresh=function(a){var b;return b=$(a.currentTarget),b.prop("disabled",!0),this.dataSource.fetch().always(function(){return b.prop("disabled",!1)}),this},b.prototype.render=function(){var a;return this.dispose(),this.$el.html(this.template()),this.dataSource=this.model.createDataSource(),this.dataSource.fetch(),this.search=this.createSearchInput(this.dataSource),this.$component("search").append(this.search.render().el),_.isEmpty(a=this.dataSource.entity.get("filters"))||(this.filterList=this.createFilterList(this.dataSource.filter,a),this.$component("filters").append(this.filterList.render().el)),this.dataGrid=this.createDataGrid(this.dataSource),this.pagination=this.createPagination(this.dataSource),this.$component("body").append(this.dataGrid.render().el).append(this.pagination.render().el),this},b.prototype.createDataGrid=function(a){return new h({model:a,entity:this.model})},b.prototype.createPagination=function(a){return new m({model:a})},b.prototype.createFilterList=function(a,b){return new l({model:a,entity:this.model,filters:b})},b.prototype.createSearchInput=function(a){return new g.Inputs.Search({model:a,key:"search"})},b.prototype.template=function(){var a;return a='<div class="content-header">\n    <div class="column column-main">\n        <h1 class="entity-title">'+this.model.getPluralTitle()+'</h1>\n\n        <div class="entity-title-buttons">\n            '+this.buttonsTemplate()+'\n        </div>\n    </div>\n\n    <div class="column column-extra">\n        <div class="entity-search-box" id="'+this.componentId("search")+'"></div>\n    </div>\n</div>\n\n<div class="content-body">\n    <div class="column column-main" id="'+this.componentId("body")+'"></div>\n    <div class="column column-extra" id="'+this.componentId("filters")+'"></div>\n</div>'},b.prototype.buttonsTemplate=function(){var a;return a='<button type="button" class="btn btn-default btn-refresh" title="'+g.lang.refresh+'">'+s("refresh")+"</button>",this.model.createPermitted()&&(a+=' <button type="button" class="btn btn-primary btn-create" title="'+g.lang.add+'">'+s("plus")+"</button>"),a},b.prototype.dispose=function(){var a,b,c,d,e,f;return null!=(a=this.form)&&a.remove(),null!=(b=this.filterList)&&b.remove(),null!=(c=this.dataGrid)&&c.remove(),null!=(d=this.pagination)&&d.remove(),null!=(e=this.search)&&e.remove(),null!=(f=this.dataSource)&&f.stopListening(),this},b.prototype.remove=function(){return this.dispose(),b.__super__.remove.apply(this,arguments)},b}(g.View),g.Entity.Form=function(a){function b(a){this.className+=" "+this.className+"-"+a.model.entity.id,b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.className="entity-form",b.prototype.events={"click .btn-save":"save","click .btn-close":"close","click .btn-destroy":"destroy","click .btn-copy":"copy"},b.prototype.initialize=function(a){var b,c,d,e;this.inner=null!=(d=a.inner)?d:!1,this.listenTo(this.model,"destroy",this.handleDestroy),this.listenTo(this.model,"invalid",this.displayInvalid),this.listenTo(this.model,"change",this.handleChange),e=this.model.related;for(b in e)c=e[b],this.listenTo(c,"change",this.handleChange);return this.hotkeys=$(document).on("keydown."+this.cid,"body",$.proxy(this,"hotkeys")),this},b.prototype.hotkeys=function(a){return a.ctrlKey&&90===a.keyCode&&a.target===document.body?(this.model.set(this.model.previousAttributes()),!1):a.ctrlKey&&13===a.keyCode?(this.save(),!1):27===a.keyCode?(this.close(),!1):this},b.prototype.handleChange=function(){return this},b.prototype.displayAlert=function(a,b,d){return null!=this.alert&&this.alert.remove(),this.alert=new c({message:a,className:"flash",type:b,timeout:d}),this.footer.prepend(this.alert.render().el),this},b.prototype.displaySuccess=function(){return this.displayAlert(g.lang.success,"success",3e3)},b.prototype.displayInvalid=function(){return this.displayAlert(g.lang.invalid,"warning",5e3)},b.prototype.displayError=function(a){var b;return"VALIDATION"!==(null!=(b=a.responseJSON)?b.error:void 0)?this.displayAlert(g.lang.failure,"danger",5e3):void 0},b.prototype.handleDestroy=function(){return this.model.entity.get("soft_deleting")?this.update():this.inner?this.remove():g.router.navigate(this.model.entity.link(),{trigger:!0}),this},b.prototype.show=function(){return this.$el.toggleClass("opened",!0),this.tabs[0].focus(),this},b.prototype.save=function(){return null==this.request?(this.request=this.model.save(null,{displayLoading:!0,xhr:function(a){return function(){var b;return b=$.ajaxSettings.xhr(),b.upload&&b.upload.addEventListener("progress",$.proxy(a,"progressCallback")),b}}(this)}),this.request.done($.proxy(this,"displaySuccess")).fail($.proxy(this,"displayError")),this.request.always(function(a){return function(){return a.request=null,a.progressBar.parent().hide(),a.update()}}(this)),this.update(),this):void 0},b.prototype.progressCallback=function(a){var b;return a.lengthComputable&&(b=100*a.loaded/a.total,this.progressBar.width(b+"%").parent().show()),this},b.prototype.close=function(){var a;return a=this.request?confirm(g.lang.confirm_abort):this.model.hasChangedSinceSync()?confirm(g.lang.confirm_discard):!0,a&&(this.request&&this.request.abort(),this.inner?this.remove():g.router.navigate(this.model.entity.link(),{trigger:!0})),this},b.prototype.destroy=function(){var a,b;if(!this.request&&!this.model.isNew())return b=this.model.entity.get("soft_deleting"),a=b?!0:confirm(g.lang.confirm_delete),a&&(this.request=this.softDeleting&&this.model.get("deleted_at")?this.model.restore:this.model.destroy({wait:!0}),this.request.always(function(a){return function(){return a.request=null}}(this))),this},b.prototype.copy=function(){var a;return this.model.entity.set("instance",a=this.model.copy()),g.router.navigate(a.link()),this},b.prototype.render=function(){return this.dispose(),this.$el.html(this.template()),this.nav=this.$(".navbar-nav"),this.footer=this.$("footer"),this.submit=this.$(".btn-save"),this.destroy=this.$(".btn-destroy"),this.copy=this.$(".btn-copy"),this.progressBar=this.$(".form-save-progress"),this.tabs=[],this.renderTab(this.model,!0),this.update()},b.prototype.renderTab=function(a,b){var c,d;return this.tabs.push(c=new k({model:a})),d="tab-"+a.entity.id,c.render().$el.insertBefore(this.footer).wrap($("<div></div>",{id:d,"class":"wrap"+(b?" active":"")})),this.nav.append(this.navTemplate(a.entity.get("title").singular,d,b)),this},b.prototype.update=function(){var a,b;return a=this.model.entity.getPermissions(),this.$el.toggleClass("loading",null!=this.request),this.submit.text(this.model.isNew()?g.lang.create:g.lang.save),this.submit.attr("disabled",null!=this.request),this.submit.toggle(this.model.isNew()?a.create:a.update),this.destroy.attr("disabled",null!=this.request),this.destroy.html(this.model.entity.isSoftDeleting()&&this.model.get("deleted_at")?"Восстановить":"<span class='glyphicon glyphicon-trash' title='"+g.lang["delete"]+"'></span>"),this.destroy.toggle(!this.model.isNew()&&a["delete"]),this.copy.toggle(!this.model.isNew()&&a.create),null!=(b=this.external)&&b.remove(),this.model.extra.external&&this.destroy.before(this.external=$(this.externalTemplate(this.model.extra.external))),this},b.prototype.template=function(){return'<div class="navbar navbar-default navbar-static-top" role="navigation">\n    <div class="container-fluid">\n        <button type="button" class="btn btn-link btn-destroy navbar-btn pull-right" type="button"></button>\n        \n        <button type="button" tabindex="-1" class="btn btn-link btn-copy navbar-btn pull-right" title="'+g.lang.copy+'">\n            <span class="glyphicon glyphicon-book"></span>\n        </button>\n        \n        <ul class="nav navbar-nav"></ul>\n    </div>\n</div>\n\n<footer>\n    <button type="button" class="btn btn-default btn-close" type="button">'+g.lang.close+'</button>\n    <button type="button" class="btn btn-primary btn-save" type="button" disabled></button>\n\n    <div class="progress"><div class="progress-bar form-save-progress"></div></div>\n</footer>'},b.prototype.externalTemplate=function(a){return'<a href="'+a+'" class="btn btn-link navbar-btn pull-right" title="'+g.lang.view_external+'" target="_blank">\n    '+s("eye-open")+"\n</a>"},b.prototype.navTemplate=function(a,b,c){return c=c?' class="active"':"","<li"+c+'><a href="#'+b+'" data-toggle="tab">'+a+"</a></li>"},b.prototype.remove=function(){return this.trigger("remove",this),this.$el.one(p,function(a){return function(){return a.dispose(),$(document).off("."+a.cid),a.trigger("removed",a),b.__super__.remove.apply(a,arguments)}}(this)).removeClass("opened"),this},b.prototype.dispose=function(){var a,b,c,d;if(null!=this.tabs)for(d=this.tabs,b=0,c=d.length;c>b;b++)a=d[b],a.remove();return this},b}(Backbone.View),d=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.initialize=function(){var a,b,c,d;for(this.container=$("body"),this.mainContent=$("#content"),this.loadingRequests=0,this.entities={},this.entitiesDfd={},d=g.entities,b=0,c=d.length;c>b;b++)a=d[b],this.entities[a.id]=new g.Entity.Entity(a);return this.on("change:entity",this.displayEntity,this),this},b.prototype.displayEntity=function(a,b){return this.dispose(),this.mainContent.hide(),b?this.container.append((this.page=new g.Entity.Page({model:b})).render().el):void 0},b.prototype.displayError=function(a){return this.dispose(),this.mainContent.html("<p class='alert alert-danger'>"+a+"</p>").show(),this},b.prototype.startLoading=function(){return 0===this.loadingRequests++&&(this.loading=setTimeout(function(a){return function(){return $(document.body).addClass("loading"),a.loading=!1}}(this),1e3)),this},b.prototype.doneLoading=function(){return 0===this.loadingRequests?void console.error("Seems like doneLoading is called too many times."):(0===--this.loadingRequests&&(this.loading?(clearTimeout(this.loading),this.loading=!1):$(document.body).removeClass("loading")),this)},b.prototype.entity=function(a){return!a in this.entities&&console.error("Unknown entity "+a),this.entities[a]},b.prototype.dispose=function(){var a;return null!=(a=this.page)&&a.remove(),this},b}(Backbone.Model),g.app=new d,n=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return y(b,a),b.prototype.initialize=function(){var a,b,c,d;return a=_.map(g.entities,function(a){return a.id}).join("|"),this.addRoute("index",a),this.addRoute("update",a,"([^/]+)"),this.addRoute("create",a,"create"),d=g.root+"/"+g.uri+"/",c=Backbone.history,b=/#.*$/,$(document.body).on("click","a",function(a){var e,f,g;return e=a.currentTarget.href.replace(b,""),g=c.fragment,0===e.indexOf(d)&&(e=e.slice(d.length))&&e!==g&&(f=c.loadUrl(e),c.fragment=g,f&&(a.preventDefault(),c.navigate(e))),a}),this},b.prototype.addRoute=function(a,b,c){var d;return null==c&&(c=null),d="^("+b+")",c&&(d+="/"+c),d+="$",this.route(new RegExp(d),a),this},b.prototype.resolveEntity=function(a){var b;return b=g.app.entity(a),b.viewPermitted()?(b.set("instance",null),g.app.set("entity",b),b):(g.app.displayError(g.lang.entity_forbidden),null)},b.prototype.index=function(a){return this.resolveEntity(a)},b.prototype.create=function(a){return console.log("create"),a=this.resolveEntity(a),a&&a.actionCreate(),a},b.prototype.update=function(a,b){return a=this.resolveEntity(a),a&&a.actionUpdate(b),a},b}(Backbone.Router),g.router=new n,Backbone.history.start({root:g.uri,pushState:!0,hashChange:!1})}).call(this);
//# sourceMappingURL=app.min.map